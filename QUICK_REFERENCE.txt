# API Gateway Analytics Endpoint - Quick Reference

## Script: `add_analytics_endpoint.sh`

### What It Does
Creates a new `/analytics` endpoint in your API Gateway with:
- ✅ Lambda proxy integration
- ✅ API Key requirement
- ✅ CORS support
- ✅ OPTIONS method for preflight
- ✅ Auto-deployment

### Prerequisites
```bash
# Install tools
brew install aws-cli jq    # macOS
apt-get install awscli jq  # Ubuntu

# Configure credentials
aws configure
```

### Quick Start (3 Steps)

**Step 1: Edit the script**
```bash
nano add_analytics_endpoint.sh
# Replace lines 36-42 with your values:
API_ID="your-api-id"
REGION="us-east-1"
LAMBDA_NAME="contactFormProcessor"
STAGE_NAME="prod"
USAGE_PLAN_NAME="contact-form-usage-plan"
API_KEY_NAME="contact-form-api-key"
FRONTEND_ORIGIN="https://yourdomain.com"
```

**Step 2: Run the script**
```bash
chmod +x add_analytics_endpoint.sh
./add_analytics_endpoint.sh
```

**Step 3: Test the endpoint**
```bash
# Without API key (should fail with 403)
curl -X POST "https://API_ID.execute-api.REGION.amazonaws.com/STAGE/analytics" \
  -H "Content-Type: application/json" \
  -d '{"form_id":"my-portfolio"}'

# With API key (should return 200)
curl -X POST "https://API_ID.execute-api.REGION.amazonaws.com/STAGE/analytics" \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: YOUR_API_KEY" \
  -d '{"form_id":"my-portfolio"}'
```

---

## Finding Your Configuration Values

### API_ID
```bash
aws apigateway get-rest-apis | jq '.items[] | {name, id}'
```
Look for your API and copy the `id`

### REGION
Your AWS region:
- `us-east-1` (N. Virginia)
- `us-west-2` (Oregon)
- `eu-west-1` (Ireland)
- etc.

### LAMBDA_NAME
```bash
aws lambda list-functions | jq '.Functions[].FunctionName'
```
Your Lambda function name (e.g., `contactFormProcessor`)

### STAGE_NAME
Usually: `prod`, `dev`, `staging`, or `production`

### FRONTEND_ORIGIN
Your website URL:
- `https://example.com`
- `https://omdeshpande09012005.github.io`
- `https://app.example.com:3000`

---

## What Each Step Does

| Step | Action | Description |
|------|--------|-------------|
| 1 | Validation | Checks placeholders and tools |
| 2 | Find /submit | Gets parent resource ID |
| 3 | Create /analytics | Creates `/analytics` resource |
| 4 | Add POST method | Adds POST HTTP method |
| 5 | Lambda integration | Connects to your Lambda |
| 6 | API Key requirement | Enables `X-Api-Key` header check |
| 7 | Add OPTIONS method | For CORS preflight requests |
| 8 | Configure CORS | Sets Allow-Origin headers |
| 9 | Lambda permissions | Grants invocation rights |
| 10 | Deploy | Pushes to specified stage |
| 11 | Verify setup | Shows summary & test commands |

---

## Testing

### Test 1: Without API Key (Should Fail)
```bash
curl -i -X POST "https://API_ID.execute-api.REGION.amazonaws.com/STAGE/analytics" \
  -H "Content-Type: application/json" \
  -d '{"form_id":"test"}'
```

**Response:** `HTTP/1.1 403 Forbidden`

---

### Test 2: With API Key (Should Succeed)
```bash
curl -i -X POST "https://API_ID.execute-api.REGION.amazonaws.com/STAGE/analytics" \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: KEY_VALUE_HERE" \
  -d '{"form_id":"test"}'
```

**Response:** `HTTP/1.1 200 OK` with JSON body

---

### Test 3: CORS Preflight
```bash
curl -i -X OPTIONS "https://API_ID.execute-api.REGION.amazonaws.com/STAGE/analytics" \
  -H "Origin: https://yourdomain.com" \
  -H "Access-Control-Request-Method: POST"
```

**Response:** `HTTP/1.1 200 OK` with CORS headers

---

## Useful Commands

### Get API Key Value
```bash
aws apigateway get-api-key --api-key KEY_ID --include-value --query 'value' --output text
```

### View All Endpoints
```bash
aws apigateway get-resources --rest-api-id API_ID | jq '.items[] | {path, id}'
```

### Check Lambda Logs
```bash
aws logs tail /aws/lambda/LAMBDA_NAME --follow
```

### Delete Endpoint
```bash
aws apigateway delete-resource --rest-api-id API_ID --resource-id RESOURCE_ID
```

### Redeploy
```bash
aws apigateway create-deployment --rest-api-id API_ID --stage-name STAGE
```

---

## Troubleshooting

| Problem | Solution |
|---------|----------|
| "Placeholder not replaced" | Edit script, replace ALL CAPS with real values |
| "Could not find /submit" | Create `/submit` first in API Gateway |
| "Lambda returns 502" | Check Lambda code handles API Gateway format |
| "CORS error in browser" | Verify `FRONTEND_ORIGIN` matches exactly |
| "API Key not working" | Check usage plan is associated with API |

---

## Idempotency

✅ **Safe to run multiple times** - The script will:
- Skip existing resources
- Update CORS headers if changed
- Re-deploy API on each run

---

## Common Configuration Examples

### Portfolio Website
```bash
API_ID="abc123def456"
REGION="us-east-1"
LAMBDA_NAME="contactFormProcessor"
STAGE_NAME="prod"
USAGE_PLAN_NAME="portfolio-usage-plan"
API_KEY_NAME="portfolio-api-key"
FRONTEND_ORIGIN="https://omdeshpande09012005.github.io"
```

### SaaS Application
```bash
API_ID="xyz789uvw123"
REGION="us-west-2"
LAMBDA_NAME="analyticsHandler"
STAGE_NAME="production"
USAGE_PLAN_NAME="saas-api-plan"
API_KEY_NAME="saas-master-key"
FRONTEND_ORIGIN="https://app.company.com"
```

### Development Environment
```bash
API_ID="dev123xyz456"
REGION="eu-west-1"
LAMBDA_NAME="contactFormProcessor-dev"
STAGE_NAME="dev"
USAGE_PLAN_NAME="dev-usage-plan"
API_KEY_NAME="dev-api-key"
FRONTEND_ORIGIN="http://localhost:3000"
```

---

## After Setup

1. **Save API Key**
   ```bash
   aws apigateway get-api-key --api-key KEY_ID --include-value > api-key.txt
   ```

2. **Update Frontend**
   - Add `X-Api-Key` header to requests
   - Point to new `/analytics` endpoint

3. **Monitor**
   ```bash
   aws logs tail /aws/lambda/LAMBDA_NAME --follow
   ```

4. **Test in Production**
   - Send test requests
   - Verify responses
   - Check logs

---

## For More Help

See: `API_GATEWAY_SCRIPT_GUIDE.md`

